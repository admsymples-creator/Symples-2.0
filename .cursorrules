# Cursor Rules
- Sempre que for criar um novo componente ou algo novo, verificar se ja existe componente ou codigo reutilizavel com a mesma identidade ou no sistema.
# Project Context
This is a Next.js 15+ project using App Router, TypeScript, Tailwind CSS, and Supabase.

# Code Style
- Use functional components.
- Use TypeScript interfaces for props.
- Use `lucide-react` for icons.
- Use `shadcn/ui` for components (if applicable).

# Server Actions and Client Components
- **CRITICAL**: Files with `"use server"` can ONLY export async functions
- **CRITICAL**: Never export types/interfaces from `"use server"` files - use `lib/types/` instead
- **CRITICAL**: Never export class instances from `"use server"` files
- Pure utility functions (synchronous) should be in separate files (e.g., `subscription-helpers.ts`)
- Server Actions that use `next/headers` (like `cookies()`) must use `await cookies()` in Next.js 15+
- Client Components should import pure functions from helper files, not from Server Action files
- Never call Server Actions inside `setState` callbacks or during render - move them outside

# Providers Architecture
- `AppShell` wraps all authenticated routes with:
  - `SidebarProvider` - Sidebar state management
  - `UIScaleProvider` - UI scale/zoom functionality (required for `useUI()` hook)
  - `TooltipProvider` - Tooltip functionality
- All Client Components that use `useUI()` must be within `UIScaleProvider`

# Subscription and Billing System

## Database Schema
- `workspaces` table has subscription fields:
  - `plan`: 'starter' | 'pro' | 'business' (default: 'business' for trial)
  - `subscription_status`: 'trialing' | 'active' | 'past_due' | 'canceled' (default: 'trialing')
  - `trial_ends_at`: Date when trial expires (14 days from creation)
  - `member_limit`: Integer based on plan (1, 5, or 15)
  - `subscription_id`: Asaas subscription ID

## Reverse Trial Flow
- New workspaces start with `plan: 'business'` and `subscription_status: 'trialing'`
- Trial lasts 14 days from workspace creation
- After trial expires, workspace is blocked from creating new items (soft lock)
- Old workspaces (>30 days) are automatically set to `subscription_status: 'active'`

## Plan Limits
- **Starter**: 1 member, 50 AI tasks/month, 500 MB storage
- **Pro**: 5 members, unlimited AI tasks, 5 GB storage
- **Business**: 15 members, unlimited AI tasks, 20 GB storage
- During trial: All workspaces get Business limits (15 members)

## Access Control (Gatekeeper)
- `checkWorkspaceAccess()` Server Action verifies workspace access
- Applied to: `createTask`, `createTransaction`, AI chat endpoints, audio processing
- Returns `{ allowed: boolean, reason?: string, upgradeRequired?: boolean }`
- Blocks creation if trial expired and status is not 'active'

## Asaas Integration
- Payment gateway integration in `lib/integrations/asaas/`
- `AsaasClient` class handles API communication (NOT a Server Action)
- Supports: Credit Card, PIX, Boleto payment methods
- Webhook endpoint: `/api/webhooks/asaas` updates subscription status

## Type Definitions
- Subscription types in `lib/types/subscription.ts`:
  - `SubscriptionData` interface for subscription data
- Pure utility functions in `lib/utils/subscription-helpers.ts`:
  - `getPlanLimits(plan, status)` - Returns member limit for plan
  - `getPlanName(plan)` - Returns formatted plan name
- Server Actions in `lib/utils/subscription.ts`:
  - `checkWorkspaceAccess(workspaceId)` - Verifies workspace access

# Task Components Architecture

## TaskRowMinify
- **Layout**: CSS Grid with fixed columns for vertical alignment
- **Indicators**: Data, Status, Assignee, Comments, Focus (⚡), Urgent (⚠)
- **Smart Triggers**: Focus (moves to next Sunday) and Urgent (marks as urgent + sets due date to today)
- **Optimistic UI**: All updates use optimistic UI pattern with rollback on error
- **Group Color**: Vertical bar indicator on the left side (1px width)
- **Hover Actions**: Focus, Urgent, and Comments appear on hover within title column
- **Column Order**: Drag Handle | Title (with hover indicators) | Date | Assignee | Status | Menu

## TaskGroup
- **Group Color Indicator**: Small colored circle next to group title (via TaskSectionHeader)
- **Spacing**: `gap-6` between groups, `mt-4` on group headers

## Optimistic UI Pattern
- Update local state immediately before Server Action
- Call `onTaskUpdatedOptimistic` callback with updates
- Rollback on error by calling `onTaskUpdatedOptimistic` with previous values
- Ensure immutability in state updates (create new array/object references)

# Common Patterns

## State Updates During Render
- **NEVER** call Server Actions inside `setState` callbacks
- **NEVER** call Server Actions during render
- Move Server Action calls outside of `setMessages`, `setState`, etc.
- Use `startTransition` for non-urgent state updates after async operations

## Error Handling
- Always wrap Server Actions in try-catch
- Return structured error objects: `{ success: boolean, error?: string }`
- Use `toast` from `sonner` for user-facing error messages

# Calendar and Date Handling

## FullCalendar Integration
- **Locale**: Uses `ptBrLocale` from `@fullcalendar/core/locales/pt-br` for Portuguese localization
- **Translation**: `moreLinkText="mais"` translates "more" link to Portuguese
- **Timezone**: FullCalendar uses local timezone by default (no `timeZone` prop needed in v6)
- **Event Display**: Personal tasks always show time (not allDay) to display hours in calendar
- **Recurrence Icon**: SVG icon displayed next to time for recurring tasks

## Date Conversion Strategy
- **Noon Strategy**: For tasks without specific time, use noon (12:00) local time before converting to ISO to prevent timezone shifts
- **UTC Handling**: Calendar headers use `getUTCDay()` because FullCalendar passes UTC dates to header renderer
- **WeeklyView Grouping**: Personal tasks use local date for grouping, workspace tasks use UTC date
- **AllDay Events**: Only workspace tasks can be allDay (00:00:00 UTC). Personal tasks always display time.

## Calendar Event Structure
- `extendedProps` includes: `status`, `priority`, `workspace_id`, `is_personal`, `workspace_name`, `recurrence_type`, `recurrence_parent_id`
- Background colors: Personal tasks = gray (#f3f4f6), Workspace tasks = workspace color
- Text colors: Personal tasks = black, Workspace tasks = white

# Recurring Tasks

## Database Schema
- `recurrence_type`: 'daily' | 'weekly' | 'monthly' | 'custom' | null
- `recurrence_interval`: number (for custom type, interval in days)
- `recurrence_end_date`: timestamp (when recurrence ends)
- `recurrence_count`: number (max occurrences)
- `recurrence_parent_id`: uuid (reference to parent task, null for parent)
- `recurrence_next_date`: timestamp (next occurrence generation date)
- **Constraint**: Only personal tasks can have recurrence (enforced by database trigger)

## Visual Indicators
- **Icon**: `RefreshCw` icon in blue appears next to time for recurring tasks
- **Location**: Icon positioned to the left of the time badge in TaskRow
- **Calendar**: SVG recurrence icon appears next to time text in FullCalendar events
- **Tooltip**: Shows recurrence type (Diária, Semanal, Mensal, Personalizada)

## Deletion
- **Modal**: `DeleteRecurringTaskModal` asks user to delete single occurrence or all occurrences
- **Query**: Uses `.or()` to delete parent + all children in single query: `recurrence_parent_id.eq.{id},id.eq.{id}`

## Creation
- Recurrence fields must be passed to `createTask` Server Action
- `DayColumn` passes `recurrenceType` state to `createTask`

# DayColumn Component

## Task Ordering
- Personal tasks sorted chronologically by `due_date` (ascending)
- Personal tasks appear before workspace tasks
- Workspace tasks maintain original order or sort by creation date

## Input Area
- No icon (removed Plus icon and dot indicator)
- Padding: `px-3 py-2` to match bottom controls alignment
- Date picker always visible in footer area

## Quick Add
- Optimistic updates for instant feedback
- Batch input support (multiple lines)
- Recurrence support via TaskDateTimePicker

# Projects System (Tags as Projects)

## Architecture
- **Projects are Tags**: Projects are represented as tags in the `tasks.tags` array column
- **No separate table**: Uses existing `tasks.tags TEXT[]` column to avoid migrations
- **Filtering**: Projects filter tasks using query parameters: `/tasks?tag=project-name`
- **Storage**: Project icons stored in `project_icons` table (workspace_id, tag_name, icon_name)

## Database Schema
- `project_icons` table:
  - `workspace_id` UUID (references workspaces)
  - `tag_name` TEXT (the project tag name)
  - `icon_name` TEXT (lucide-react icon name)
  - Primary key: (workspace_id, tag_name)
  - RLS policies: Members can read/write icons for their workspaces

## Project Icons
- **Icon Picker**: 30 minimalist icons from `lucide-react` in `components/projects/IconPicker.tsx`
- **Design**: Background `#050815` (almost black blue), white icon, rounded borders
- **Storage**: Icons stored in `project_icons` table via `setProjectIcon()` Server Action
- **Display**: Icons shown in Sidebar and ProjectCard with consistent styling
- **Default**: `Folder` icon if no icon specified

## Server Actions
- `lib/actions/projects.ts`:
  - `getProjectIcon(workspaceId, tagName)` - Get icon for a specific project
  - `getProjectIcons(workspaceId)` - Get all project icons for a workspace (returns Map)
  - `setProjectIcon(workspaceId, tagName, iconName)` - Set/update project icon
  - `deleteProjectIcon(workspaceId, tagName)` - Delete project icon
- `lib/actions/tasks.ts`:
  - `getWorkspaceTags(workspaceId)` - Returns tags from tasks AND project_icons table
  - Includes projects without tasks yet (tags with saved icons)

## Context-Aware Creation
- When creating a task within a project context (`/tasks?tag=project-name`):
  - `TaskDetailModal` receives `initialTags` prop with the project tag
  - Tag field is pre-filled with the current project's tag
  - Project selector in modal allows selecting/removing project tag

## Sidebar Integration
- **PROJETOS Section**: Shows all workspace tags (projects) with their icons
- **Icon Display**: Each project shows its custom icon with `bg-[#050815]` background
- **Active State**: Project is active when `searchParams.get('tag') === project-tag`
- **Creation**: Modal with name input and icon picker (30 icons, no scroll)

## Home Integration
- **Project Cards**: `ProjectCard` component displays project statistics
- **Icon Display**: Shows project icon with `bg-[#050815]` background (replaces gradient)
- **Navigation**: Clicking card navigates to `/tasks?tag=project-name`
- **Overview**: `HomeWorkspaceOverview` shows "Visão por Projeto" for professional workspaces

# Workspace Hierarchy and Navigation

## Workspace Types
- **Personal Workspace**: Special workspace that aggregates information from all workspaces
- **Professional Workspace**: Regular workspace with its own tasks and projects

## Personal Workspace Rules
- **No Tasks**: Personal workspace does NOT have its own tasks (`workspace_id = null` for personal tasks)
- **Aggregation Only**: Shows tasks from all other workspaces when user is assignee
- **Home View**: Shows "Visão por Workspace" (overview of all professional workspaces)
- **Planner View**: Shows tasks from all workspaces when in personal context
- **Sidebar**: Hides "Tarefas" and "Time" items (not applicable to personal workspace)

## Professional Workspace Rules
- **Own Tasks**: Has tasks with `workspace_id = workspace.id`
- **Home View**: Shows "Visão por Projeto" (overview of projects/tags)
- **Planner View**: Shows only tasks from the active workspace
- **Sidebar**: Shows all management items including "Tarefas" and "Time"

## Workspace Detection
- **Helper Function**: `isPersonalWorkspace(workspace, allWorkspaces)` in `lib/utils/workspace-helpers.ts`
- **Heuristics**:
  1. Name is "Pessoal" (case-insensitive)
  2. Slug starts with "pessoal-"
  3. Only workspace and name/slug suggests personal
- **Usage**: Always use helper function, never literal string comparison

## Navigation Structure
- **Top (Context)**: `<WorkspaceSwitcher />` - Access to Personal or Professional context
- **GESTÃO Section**: Core management items (Home, Planner, Tasks, Finance, Team)
- **PROJETOS Section**: Client work projects (tags with icons)
- **URL Structure**: `/[workspaceSlug]/page` or `/page` (uses active workspace from context)

## Planner Separation
- **Personal Workspace**: 
  - `PlannerClient` detects personal workspace using `isPersonalWorkspace()` helper
  - Fetches tasks with `assigneeId: "current"` and no `workspaceId` (all workspaces)
  - `PlannerCalendar` receives `workspaceId: undefined` to show all tasks
- **Professional Workspace**:
  - `PlannerClient` detects professional workspace
  - Fetches tasks with `workspaceId: currentWorkspace.id` and `assigneeId: "current"`
  - `PlannerCalendar` receives `workspaceId: workspace.id` to show only workspace tasks
- **Synchronization**: Both `WeeklyView` and `PlannerCalendar` use same filtering logic